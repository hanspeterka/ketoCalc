<script type="text/javascript">
application.register("recipe-reactions", class extends Stimulus.Controller {
	static get targets() {
		return ["recipes"]
	}

	connect() {
		this.add_reaction_buttons();
	}

	add_reaction_buttons() {
		for (let i = 0, recipe; recipe = this.recipesTarget.children[i]; i++) {
			this._set_recipe_icon(recipe)
		}
	}

	toggle_reaction(event){
		var recipe = event.target.parentNode.parentNode
		fetch("{{ url_for('RecipesView:toggle_reaction_AJAX') }}",{
			method: 'POST',
			body: JSON.stringify({'recipe_id' : recipe.dataset.recipeId}),
			headers: {'Content-Type': 'application/json,charset=UTF-8'}}
		).then((response) => {
			return response.json(); }
		).then((response) => {
			recipe.dataset.reaction=response
			this._set_recipe_icon(recipe, true)
		});
	}

	_set_recipe_icon(recipe, from_toggle=false){
		var last_cell = recipe.children[recipe.children.length - 1]
		// remove old icon
		if (last_cell.getElementsByTagName('i').length > 0) {
			last_cell.getElementsByTagName('i')[0].remove()
		}


		if (from_toggle == true && recipe.dataset.reaction == "true"){
			last_cell.getElementsByTagName('span')[0].innerHTML++;
		} else if (from_toggle == true && recipe.dataset.reaction == "false") {
			last_cell.getElementsByTagName('span')[0].innerHTML--;
		}

		var icon = ""
		if (recipe.dataset.reaction == "true") {
			icon = this._full_heart_icon(recipe)
		} else {
			icon = this._empty_heart_icon(recipe)
		}

		last_cell.innerHTML = icon + last_cell.innerHTML
	}

	_empty_heart_icon(recipe) {
		return '<i class="far fa-heart color-red"\
	 				data-recipe-id="'+ recipe.dataset.recipeId +'"\
	 				data-action="click->recipe-reactions#toggle_reaction">\
		 		</i>'
	}

	_full_heart_icon(recipe){
		return '<i class="fas fa-heart color-red"\
					data-recipe-id="'+ recipe.dataset.recipeId +'"\
					data-action="click->recipe-reactions#toggle_reaction">\
				</i>'
	}

});
</script>
