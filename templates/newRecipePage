<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Nový recept</title>

        {% include('bootstrap') %} 
        {% include('styleBody') %}

        <script type="text/javascript">

            /// On ready - change visibility to default
            $(document).ready(function() {
                selectAllIngredients = String(document.getElementById("ingredientSelect").innerHTML);
                // $("#addRecipe").css('visibility', 'hidden');
                $("#right").css('visibility', 'hidden');
                $("#wrong").css('visibility', 'hidden');
                $(".loader").css('visibility', 'hidden');
            });

            /// Removing ingredient from list of selected ingredients
            $(function(){
                  $('#selectedIngredients').on('click','tr button.remove',function(e){
                     e.preventDefault();
                    $(this).parents('tr').remove();

                    temp_id = $(this).attr('id');
                    temp_array=$('#ingredientsArray').val().split(", ");
                    temp_array.splice($.inArray(temp_id, temp_array),1);


                    $('#ingredientsArray').val("");
                    for (let i = 0; i < temp_array.length; i++) {
                        temp_val = $('#ingredientsArray').val();
                        if (temp_val === "") {
                            $('#ingredientsArray').val(temp_array[i]);
                        }else{
                            $('#ingredientsArray').val(temp_val + ", " + temp_array[i]);
                        }
                    }

                    // Restore default options
                    $('#ingredientSelect').empty();
                    $('#ingredientSelect').append(selectAllIngredients);


                    // Remove used options
                    for (let j = 0; j < temp_array.length; j++) {
                        $('#ingredientSelect option[value="' + temp_array[j] + '"]').remove(); // wip
                    }
                  });
            });

            /// Adding ingredient from select to list of selected ingredients
            $(document).on("submit", "#addIngredientForm", function(e) {
                    $.ajax({
                        type: 'POST',
                        url: '/addIngredientAJAX',
                        data: $(this).serialize(),
                        success: function(response) {
                            $("#ingredientSelect option[value='" + response.id + "']").remove();
                            $('#selectedIngredients').append(
                                "<tr>" + 
                                    "<td>" + response.name + "</td>" +
                                    "<td>" + response.protein+ "</td>" +
                                    "<td>" + response.fat + "</td>"+
                                    "<td>" + response.sugar + "</td>"+
                                    "<td>" +
                                        '<button id="' + response.id + '" class="remove btn btn-warning">Ubrat</button>' +
                                    "</td>"+
                                    "<td>" +
                                        '<input type="radio" onclick="setMainIngredient('+ response.id +')" class="form-check-input" name="Proměnná"/>' +
                                    "</td>"+
                                "</tr>");

                            var temp_array = $('#ingredientsArray').val();
                            if (temp_array.length === 0) {
                                $('#ingredientsArray').val(response.id);
                            } else {
                                $('#ingredientsArray').val(temp_array + ", " + response.id);
                            }

                            // $("#addRecipe").css('visibility', 'hidden');
                            $("#right").css('visibility', 'hidden');
                            $("#wrong").css('visibility', 'hidden');
                            $(".loader").css('visibility', 'hidden');
                            
                        },
                        error: function(error) {
                            // console.log(error);
                        }

                    });
                    e.preventDefault();
            });

            /// Running loader animation
            $(document).on("click", "#calcRecipe", function() {
                $(".loader").css('visibility', 'visible');
            });


            /// Making recipe table for confirmation and costumization
            $(document).on("submit", "#calcRecipeForm", function(e) {
                    $.ajax({
                        type: 'POST',
                        url: '/calcRecipeAJAX',
                        data: $(this).serialize(),
                        success: function(response){

                            $('#ingredientsArray2').val("");        //solution?
                            $('#ingredientsAmount').val("");        //solution?
                            $('#ingredientsArray').val("");
                            $('#selectedIngredients').empty();

                            $("#selectedIngredients").append(
                                '<tr>'+
                                    '<th>Název</th>'+
                                    '<th>Bílkovina</th>'+
                                    '<th>Tuk</th>'+
                                    '<th>Sacharidy</th>'+
                                    '<th></th>'+
                                    '<th>Nastavitelné?</th>'+
                                '</tr>');

                            $('#ingredientSelect').empty();
                            $('#ingredientSelect').append(selectAllIngredients);

                            $('#selectedIngredientsAdd').empty();
                            $('#selectedIngredientsAdd').append(
                                '<tr>'+
                                    '<th>Název</th>'+
                                    '<th>Bílkovina</th>'+
                                    '<th>Tuk</th>'+
                                    '<th>Sacharidy</th>'+
                                    '<th>Množství</th>'+
                                    '<th></th>'+
                                '</tr>');

                            if (response=="False"){
                                $(".loader").css('visibility', 'hidden');
                                $("#right").css('visibility', 'hidden');
                                $("#wrong").css('visibility', 'visible');
                                return;
                            }
                            totalSugar = 0;
                            totalFat = 0;
                            totalProtein = 0;
                            var ingredients = response.ingredients;
                            // ingredients to table
                            for (i = 0; i<response.ingredients.length; i++ ){

                                if (response.mainIngredientID == ingredients[i].id){
                                    $('#selectedIngredientsAdd').append(
                                        "<tr>" +
                                        "<td>" + ingredients[i].name + "</td>" +
                                        "<td>" + ingredients[i].protein + "</td>" +
                                        "<td>" + ingredients[i].fat + "</td>" +
                                        "<td>" + ingredients[i].sugar + "</td>" +
                                        '<td><span id="amount_' + ingredients[i].id + '">' + Math.round(ingredients[i].amount)+ " g</span></td>" + 
                                        '<td id="slider_tr" name="'+ response.mainIngredientID +'">' + 
                                            '<input type="range"' +
                                                'id="slider"' + 
                                                'name="slider"' + 
                                                'min="' + response.mainIngredientMin + '" '+
                                                'max="' + response.mainIngredientMax + '" '+
                                                'step="0.1" '+
                                                'oninput="showSliderVal(this.value, amount_'+ingredients[i].id + ')" '+
                                                'onchange="showSliderVal(this.value, amount_'+ingredients[i].id + ')">' +
                                            '<span id="sliderVal"></span>' + 
                                        '</td>' + 
                                        '</tr>');
                                }
                                else {
                                    $('#selectedIngredientsAdd').append(
                                        "<tr>" +
                                        "<td>" + ingredients[i].name + "</td>" +
                                        "<td>" + ingredients[i].protein + "</td>" +
                                        "<td>" + ingredients[i].fat + "</td>" +
                                        "<td>" + ingredients[i].sugar + "</td>" +
                                        '<td><span id="amount_' + ingredients[i].id + '">' + Math.round(ingredients[i].amount)+ " g</span></td>" +
                                        "</tr>");
                                }
                                
                                totalProtein += ingredients[i].protein*ingredients[i].amount;
                                totalFat += ingredients[i].fat*ingredients[i].amount;
                                totalSugar += ingredients[i].sugar*ingredients[i].amount;
                            }

                            $('#selectedIngredientsAdd').append(
                                "<tr>" +
                                "<td><strong>Součet</strong></td>" +
                                "<td>" + Math.round(totalProtein/100) + "</td>" + 
                                "<td>" + Math.round(totalFat/100) + "</td>" + 
                                "<td>" + Math.round(totalSugar/100) + "</td>" + 
                                "</tr>");

                            // ingredient IDs
                            
                            for (i = 0; i<ingredients.length; i++ ){
                                var temp_array = $('#ingredientsArray2').val();
                                if (temp_array.length === 0) {
                                    $('#ingredientsArray2').val(ingredients[i].id);
                                } else {
                                    $('#ingredientsArray2').val(temp_array + ", " + ingredients[i].id);
                                }
                            }

                            // ingredient amounts
                            
                            for (i = 0; i<ingredients.length; i++ ){
                                var temp_array2 = $('#ingredientsAmount').val();
                                if (temp_array2.length === 0) {
                                    $('#ingredientsAmount').val(Math.round(ingredients[i].amount));
                                } else {
                                    $('#ingredientsAmount').val(temp_array2 + ", " + Math.round(ingredients[i].amount));
                                }
                            }

                            // diet ID
                            $('#selectedDietID').val(response.dietID);

                            // change visibility
                            // $("#addRecipe").css('visibility', 'visible');
                            $(".loader").css('visibility', 'hidden');
                            $("#wrong").css('visibility', 'hidden');
                            $("#right").css('visibility', 'visible');

                        },
                        error: function(error) {
                            // console.log(error);
                        }
                    });
                    e.preventDefault();
                });

            /// Recalculating amounts 
            $(document).on("change", "#slider", function(e) {
                // $(".loader").css('visibility', 'visible');
                dietID = $('#selectedDietID').val();
                ingredientsArray = $('#ingredientsArray2').val();
                slider = $('#slider').val();
                mainIngredientID = $('#slider_tr').attr('name');

                $.ajax({
                        type: 'POST',
                        url: '/recalcRecipeAJAX',
                        data: JSON.stringify({'dietID': dietID, 'ingredientsArray': ingredientsArray, 'slider': slider, 'mainID': mainIngredientID}, null, '\t'),
                        contentType: 'application/json;charset=UTF-8',

                        success: function(response) {
                            // alert("success");
                            x = response.x;
                            $('#amount_'+x.id).text(x.amount + " g");
                            y = response.y;
                            $('#amount_'+y.id).text(y.amount + " g");
                            z = response.z;
                            $('#amount_'+z.id).text(z.amount + " g");
                            slider = response.slider;
                            $('#amount_'+ slider.id).text(slider.amount + " g");

                            ingredients = [x,y,z,slider];

                            $('#ingredientsAmount').val("");
                            for (i = 0; i<ingredients.length; i++ ){
                                var temp_array2 = $('#ingredientsAmount').val();
                                if (temp_array2.length === 0) {
                                    $('#ingredientsAmount').val(ingredients[i].amount);
                                } else {
                                    $('#ingredientsAmount').val(temp_array2 + ", " + ingredients[i].amount);
                                }
                            }
                            console.log($('#ingredientsAmount').val());

                        },
                        error: function(error) {
                        }

                    });
                    e.preventDefault();
            });

            function setMainIngredient(id){
                $('#mainIngredientID').val(id);
            }

            function showSliderVal(value){
                $('#sliderVal').text(value);
            }

        </script>
        
        <style type="text/css" media="screen">
            #wrong{
                visibility: hidden;
            }

            #right{
                visibility: hidden;
            }

            .loader {
                visibility: hidden;
                border: 16px solid #f3f3f3; /* Light grey */
                border-top: 16px solid #337ab7; /* Blue */
                border-radius: 50%;
                width: 120px;
                height: 120px;
                animation: spin 2s linear infinite;
                margin: 40px auto;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    </head>
    <body>
        {% include('navbar') %}
        <div class="container row">
            <div class="col-md-6" style="margin-top: 40px">

                <div class="form-group col-sm-12">
                    <form id="addIngredientForm" method="POST" action="/addIngredientAJAX">
                        <select id="ingredientSelect" name="ingredient" class="form-control">
                        {% for ingredient in ingredients: %}
                            <option name={{ingredient.name}} value="{{ingredient.id}}">{{ingredient.name}}</option>
                        {% endfor %}
                        </select>
                        <input id="ajaxButton" type="submit" class="btn btn-primary" value="Přidat surovinu" />
                    </form>
                </div>
                

                <div id="selectedIngredientsDiv" class="col-sm-12">
                    <form id="selectMain" method="POST" class="form-group">
                        <table id="selectedIngredients" class="table">
                            <tr>
                                <th>Název</th>
                                <th>Bílkovina</th>
                                <th>Tuk</th>
                                <th>Sacharidy</th>
                                <th></th>
                                <th>Nastavitelné?</th>
                            </tr>
                        </table>
                    </form>
                </div>

                <div class="col-sm-12">
                    <form id="calcRecipeForm" method="POST" class="form-group" action="/calcRecipeAJAX">
                        <label for="recipeDiet">Název diety</label>
                        <select name="recipeDiet" class="form-control">
                        {% for diet in diets: %}
                            <option value="{{diet.id}}">{{ diet.name }}</option>
                        {% endfor %}
                        </select>
                        <input id="calcRecipe" type="submit" class="btn btn-primary" value="Spočítat množství!" />
                        <input type="hidden" id="ingredientsArray" name="ingredientsArray" value="" />
                        <input type="hidden" id="mainIngredientID" name="mainIngredientID" value="" />
                    </form>
                </div>

            </div>


            <div class="col-md-6" id=addRecipe style="position: relative;">

                <div class="loader"></div>

                <div id="wrong" class="offset-md-6" style="position:absolute; top:0px;">
                    <span class="problem" style="text-align: center">Recept nelze vytvořit</span>
                </div>

                <div id="right" style="position:absolute; top:0px;">
                    <form id="addRecipeForm" method="POST" action="/saveRecipeAJAX" class="form-group">
                        <label for="recipeName">Název receptu</label>
                        <input type="text" name="recipeName" required class="form-control"/>
                        
                        <table id="selectedIngredientsAdd" class="table">
                            <tr>
                                <th>Název</th>
                                <th>Bílkovina</th>
                                <th>Tuk</th>
                                <th>Sacharidy</th>
                                <th>Množství</th>
                                <th></th>
                            </tr>
                        </table>
                        
                        <div class="form-inline">
                            <div class="col-md-4">
                                <select name="size" id="food_size" class="form-control">
                                    <option value="big">Velké jídlo</option>
                                    <option value="small">Malé jídlo</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                            </div>
                            <div class="col-md-4">
                                <input id="addRecipeButton" type="submit" class="btn btn-primary" value="Uložit mezi recepty" />
                            </div>
                        </div>
                        
                        <input type="hidden" id="ingredientsArray2" name="ingredientsArray2" value="" />
                        <input type="hidden" id="selectedDietID" name="selectedDietID" value="" />
                        <input type="hidden" id="ingredientsAmount" name="ingredientsAmount" value="" />
                    </form>
                </div>
            </div>

            
        </div>
    </body>
</html>

        